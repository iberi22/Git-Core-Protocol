name: ðŸ“§ Email Notification Cleanup

on:
  schedule:
    # Aggressive: Every hour (public repos only)
    - cron: "0 * * * *"
    # Moderate: Every 6 hours (private main repo)
    - cron: "0 */6 * * *"
    # Conservative: Once daily (fallback)
    - cron: "0 9 * * *"

  workflow_dispatch:
    inputs:
      max_emails:
        description: "Maximum emails to process"
        required: false
        default: "50"
        type: string

permissions:
  contents: read

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 0: Check if should run
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  check-config:
    name: ðŸ”§ Check Config
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should_run: ${{ steps.decide.outputs.should_run }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect Repository Type
        id: detect
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ./scripts/detect-repo-config.ps1

      - name: Decide if should run
        id: decide
        shell: pwsh
        run: |
          $scheduleMode = "${{ steps.detect.outputs.schedule_mode }}"
          $eventName = "${{ github.event_name }}"
          $cronMinute = "${{ github.event.schedule }}"

          $shouldRun = "false"

          # Manual dispatch: Always run
          if ($eventName -eq "workflow_dispatch") {
            $shouldRun = "true"
            Write-Host "âœ… Manual dispatch: Running"
          }
          # Scheduled: Check mode
          elseif ($eventName -eq "schedule") {
            switch ($scheduleMode) {
              "aggressive" {
                # Public repos: Run every hour
                if ($cronMinute -match "0 \* \* \* \*") {
                  $shouldRun = "true"
                  Write-Host "âœ… Aggressive mode: Running (hourly)"
                }
              }
              "moderate" {
                # Main private repo: Run every 6 hours
                if ($cronMinute -match "0 \*/6 \* \* \*") {
                  $shouldRun = "true"
                  Write-Host "âš ï¸ Moderate mode: Running (6-hourly)"
                }
              }
              "conservative" {
                # Other private repos: Run daily only
                if ($cronMinute -match "0 9 \* \* \*") {
                  $shouldRun = "true"
                  Write-Host "ðŸ”’ Conservative mode: Running (daily)"
                }
              }
            }
          }

          Add-Content -Path $env:GITHUB_OUTPUT -Value "should_run=$shouldRun"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Cleanup Email Notifications
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cleanup-notifications:
    name: ðŸ“§ Process Emails
    needs: check-config
    if: needs.check-config.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ” Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd tools/email-handler
          pip install -r requirements.txt

      - name: ðŸ” Setup Gmail Credentials
        env:
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          cd tools/email-handler

          # Crear credentials.json desde secret
          echo "$GMAIL_CREDENTIALS" > credentials.json

          # Crear token.json desde secret si existe
          if [ -n "$GMAIL_TOKEN" ]; then
            echo "$GMAIL_TOKEN" > token.json
          fi

      - name: ðŸ“§ Process Notifications
        env:
          GH_TOKEN: ${{ github.token }}
          MAX_EMAILS: ${{ github.event.inputs.max_emails || '50' }}
        run: |
          cd tools/email-handler
          python src/main.py --max-emails $MAX_EMAILS

      - name: ðŸ’¾ Update Token (if refreshed)
        if: always()
        run: |
          cd tools/email-handler
          if [ -f token.json ]; then
            echo "Token file exists, should be updated in secrets manually"
            # Note: GitHub Actions cannot update secrets automatically
            # User must copy the new token.json content to GMAIL_TOKEN secret
          fi

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“§ Email Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Email handler executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check logs for details on processed emails." >> $GITHUB_STEP_SUMMARY
